<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Overlay Twitch – Follow Progress</title>
  <style>
    body { margin:0; overflow:hidden; background:transparent; }
    #login {
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      font-family:sans-serif;
    }
    #progress-container {
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      width:250px;
      display:none;
      flex-direction:column;
      align-items:center;
      font-family:"Segoe UI",sans-serif;
    }
    #progress-ring {
      width:200px; height:auto;
    }
    #progress-ring circle {
      stroke-linecap:round;
      transition: stroke-dashoffset 0.5s ease;
      filter:
        drop-shadow(0 0 2px rgba(231,76,60,0.6))
        drop-shadow(0 0 4px rgba(231,76,60,0.4));
    }
    .ring-bg {
      stroke:black; stroke-width:12; fill:none;
    }
    .ring-progress {
      stroke:url(#progressGradient); stroke-width:12; fill:none;
      transform:rotate(-90deg);
      transform-origin:50% 50%;
    }
    #progress-percentage {
      position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      font:1000 45px "Segoe UI", sans-serif;
      color:#ff1900;
      pointer-events:none;
    }
    #follow-count {
      margin-top:12px;
      font:1000 35px "Segoe UI", sans-serif;
      color:#ff1900;
      text-shadow:1px 1px 2px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>

  <!-- 1) Bouton de login -->
  <div id="login">
    <button id="btnLogin">Se connecter à Twitch</button>
  </div>

  <!-- 2) Configuration manuelle -->
  <div id="manual-config" style="display:none;">
    <div style="text-align:center; font-family:sans-serif; background:white; padding:20px; border-radius:10px;">
      <h3>Configuration du nombre de followers</h3>
      <p>Twitch a supprimé l'API pour récupérer automatiquement le nombre de followers.</p>
      <p>Entrez votre nombre actuel de followers :</p>
      <input type="number" id="follower-input" placeholder="Nombre de followers" style="padding:10px; margin:10px; font-size:16px;">
      <br>
      <button id="save-followers" style="padding:10px 20px; font-size:16px; margin:5px;">Sauvegarder</button>
      <button id="test-display" style="padding:10px 20px; font-size:16px; margin:5px; background:orange; color:white;">Test avec 1 follower</button>
    </div>
  </div>

  <!-- 3) Anneau de progression -->
  <div id="progress-container">
    <svg id="progress-ring" viewBox="0 0 120 120">
      <defs>
        <linearGradient id="progressGradient"
                        gradientUnits="objectBoundingBox"
                        gradientTransform="rotate(-90 0.5 0.5)">
          <stop offset="0%" stop-color="orange"/>
          <stop offset="100%" stop-color="red"/>
        </linearGradient>
      </defs>
      <circle class="ring-bg"   cx="60" cy="60" r="54"/>
      <circle class="ring-progress" cx="60" cy="60" r="54"/>
    </svg>
    <div id="progress-percentage">0%</div>
    <div id="follow-count">0 follows</div>
  </div>

  <script>
    // === CONFIG & OAuth ===
    const CLIENT_ID    = 'trn5ak33y0crkdry0jza9h31vxdgp4';  // ← remplace par ton Client ID
    const REDIRECT_URI = location.origin + location.pathname;
    const SCOPES       = 'moderator:read:followers'; // scope pour lire les followers

    // 1) Gérer le fragment #access_token
    if (location.hash.includes('access_token')) {
      const params = new URLSearchParams(location.hash.slice(1));
      localStorage.setItem('twitch_token', params.get('access_token'));
      history.replaceState(null,'',REDIRECT_URI);
    }

    // 2) Affichage du login ou de l’overlay
    const btnLogin   = document.getElementById('btnLogin');
    const divLogin   = document.getElementById('login');
    const divOverlay = document.getElementById('progress-container');
    const divManualConfig = document.getElementById('manual-config');

    function showLogin() {
      divLogin.style.display   = 'block';
      divOverlay.style.display = 'none';
      divManualConfig.style.display = 'none';
      btnLogin.onclick = () => {
        showManualConfig(); // Aller directement à la config manuelle
      };
    }

    function showManualConfig() {
      divLogin.style.display   = 'none';
      divOverlay.style.display = 'none';
      divManualConfig.style.display = 'block';
      
      // Gérer la sauvegarde des followers
      document.getElementById('save-followers').onclick = () => {
        const input = document.getElementById('follower-input');
        const count = parseInt(input.value) || 0;
        localStorage.setItem('manual_followers', count);
        followCount = count;
        
        // Déterminer la phase de départ
        for (let i=0; i<MILESTONES.length; i++) {
          if (followCount < MILESTONES[i]) {
            phaseIndex = i;
            break;
          }
        }
        
        showOverlay();
        updateProgress();
      };
      
      // Gérer le bouton de test
      document.getElementById('test-display').onclick = () => {
        testDisplay();
      };
    }

    function showOverlay() {
      divLogin.style.display   = 'none';
      divOverlay.style.display = 'flex';
      divManualConfig.style.display = 'none';
    }

    // === LOGIQUE DU RING ===
    const MILESTONES = [0, 10, 25, 50, 100, 250, 500];
    let followCount = 0, phaseIndex = 0, pausing = false;
    const ring = document.querySelector('.ring-progress');
    const pctEl = document.getElementById('progress-percentage');
    const countEl = document.getElementById('follow-count');
    const RADIUS = 54;
    const CIRC   = 2 * Math.PI * RADIUS;
    ring.style.strokeDasharray  = CIRC;
    ring.style.strokeDashoffset = CIRC;

    function updateProgress() {
      const target = MILESTONES[phaseIndex];
      const lower  = phaseIndex>0 ? MILESTONES[phaseIndex-1] : 0;
      const rawPct = (followCount - lower) / (target - lower);
      const pct = Math.min(Math.max(rawPct,0),1);
      ring.style.strokeDashoffset = CIRC * (1 - pct);
      pctEl.textContent   = `${Math.floor(rawPct*100)}%`;
      countEl.textContent = `${followCount.toLocaleString()} / ${target.toLocaleString()} follows`;

      if (followCount >= target
          && phaseIndex < MILESTONES.length-1
          && !pausing) {
        pausing = true;
        setTimeout(()=>{
          phaseIndex++;
          pausing = false;
          updateProgress();
        }, 3000);
      }
    }

    // === FONCTION DE TEST ===
    function testDisplay() {
      console.log('Test d\'affichage avec des données factices');
      followCount = 1; // Simule 1 follower
      phaseIndex = 0;
      showOverlay();
      updateProgress();
    }

    // === FETCH DES DONNÉES TWITCH ===
    async function fetchFollowCount() {
      const token = localStorage.getItem('twitch_token');
      if (!token) {
        console.log('Pas de token trouvé');
        return;
      }
      
      try {
        const headers = {
          'Client-ID': CLIENT_ID,
          'Authorization': `Bearer ${token}`
        };
        
        console.log('Début de la récupération des données...');
        
        // a) Récupère l'user_id
        const userResponse = await fetch('https://api.twitch.tv/helix/users', { headers });
        if (!userResponse.ok) {
          throw new Error(`Erreur utilisateur: ${userResponse.status}`);
        }
        const userData = await userResponse.json();
        const userId = userData.data[0].id;
        const username = userData.data[0].display_name;
        
        console.log(`Utilisateur: ${username} (ID: ${userId})`);
        
        // b) Récupère le nombre d'abonnés (followers)
        const followersResponse = await fetch(
          `https://api.twitch.tv/helix/channels/followers?broadcaster_id=${userId}`,
          { headers }
        );
        
        if (!followersResponse.ok) {
          const errorText = await followersResponse.text();
          console.error(`Erreur followers: ${followersResponse.status} - ${errorText}`);
          throw new Error(`Erreur followers: ${followersResponse.status}`);
        }
        
        const followersData = await followersResponse.json();
        followCount = followersData.total || 0;
        
        console.log(`Nombre d'abonnés récupéré: ${followCount}`);
        console.log('Données followers complètes:', followersData);
        
        // détermine phase de départ
        for (let i=0; i<MILESTONES.length; i++) {
          if (followCount < MILESTONES[i]) {
            phaseIndex = i;
            break;
          }
        }
        
        // Force l'affichage même si followCount = 0
        updateProgress();
        
      } catch (error) {
        console.error('Erreur lors de la récupération des données:', error);
        // Afficher un message d'erreur à l'utilisateur
        countEl.textContent = `Erreur: ${error.message}`;
      }
    }

    // === INITIALISATION ===
    (()=>{
      console.log('Initialisation...');
      
      // Vérifier s'il y a un nombre de followers sauvegardé
      const savedFollowers = localStorage.getItem('manual_followers');
      if (savedFollowers) {
        followCount = parseInt(savedFollowers);
        console.log('Followers sauvegardés trouvés:', followCount);
        
        // Déterminer la phase de départ
        for (let i=0; i<MILESTONES.length; i++) {
          if (followCount < MILESTONES[i]) {
            phaseIndex = i;
            break;
          }
        }
        
        showOverlay();
        updateProgress();
      } else {
        console.log('Pas de followers sauvegardés, affichage du login');
        showLogin();
      }
    })();
  </script>
</body>
</html>
